<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</title>
  <style>
    /* èµ›åšæœ‹å…‹æš—è‰²é£æ ¼ä¸»é¢˜ */
    :root {
      --bg: #0a0f1e;
      --panel: #131a2a;
      --text: #c8d6ff;
      --accent: #7c4dff;
      --accent2: #00e5ff;
      --danger: #ff3b3b;
      --ok: #5cff8d;
    }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; background: var(--bg); color: var(--text); }
    .navbar { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background: linear-gradient(90deg, rgba(124,77,255,0.2), rgba(0,229,255,0.2)); border-bottom: 1px solid rgba(200,214,255,0.1); }
    .brand { font-weight:700; letter-spacing:1px; }
    .credit { font-weight:600; color: var(--accent2); }
    .container { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .panel { background: var(--panel); border: 1px solid rgba(200,214,255,0.08); border-radius: 12px; padding: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .card { background: rgba(19,26,42,0.9); border: 1px solid rgba(200,214,255,0.08); border-radius: 12px; padding: 12px; }
    .name { font-weight:700; margin-bottom:8px; }
    .tag { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border: 1px dotted rgba(200,214,255,0.3); margin-right:6px; }
    .btn { padding:8px 10px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn + .btn { margin-left:6px; }
    .btn-primary { background: var(--accent); color:white; }
    .btn-secondary { background: var(--accent2); color:#051016; }
    .btn-danger { background: var(--danger); color:white; }
    .btn-ghost { background: transparent; color: var(--text); border:1px solid rgba(200,214,255,0.18); }
    .row { display:flex; gap:8px; align-items:center; margin-top:10px; }
    .input { padding:8px; border-radius:8px; border:1px solid rgba(200,214,255,0.18); background:#0e1424; color: var(--text); }
    .modal-backdrop { position:fixed; inset:0; background: rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; }
    .modal { width: 360px; background: var(--panel); border: 1px solid rgba(200,214,255,0.12); border-radius: 12px; padding: 16px; }
    .muted { color: #9badff; font-size: 12px; }
    
    /* ç™»å½•ç•Œé¢ç¾åŒ– */
    #loginModal { background: radial-gradient(1200px 600px at 20% 10%, rgba(124,77,255,0.2), transparent), radial-gradient(800px 400px at 80% 80%, rgba(0,229,255,0.18), transparent), rgba(0,0,0,0.8); }
    .login-hero { width: min(560px, 92vw); position: relative; padding: 28px; border-radius: 16px; background: linear-gradient(180deg, rgba(124,77,255,0.15), rgba(0,229,255,0.12)); border:1px solid rgba(124,77,255,0.35); box-shadow: 0 20px 40px rgba(0,0,0,0.55); }
    .login-title { font-size: 22px; font-weight:800; letter-spacing:1px; margin-bottom:12px; }
    .login-sub { font-size:13px; color:#9badff; margin-bottom:12px; }
    .login-actions { display:flex; justify-content:flex-end; margin-top:16px }
    .input-icon { position:relative }
    .input-icon input { padding-left:34px }
    .input-icon .ico { position:absolute; left:10px; top:50%; transform:translateY(-50%); opacity:0.75 }
    @keyframes glow { 0%{ box-shadow:0 0 0 rgba(124,77,255,0.4)} 50%{ box-shadow:0 0 14px rgba(124,77,255,0.65)} 100%{ box-shadow:0 0 0 rgba(124,77,255,0.4)} }
    .btn-primary { animation: glow 2.4s ease-in-out infinite }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand">âš—ï¸ å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</div>
    <div style="display:flex; align-items:center; gap:8px">
      <div id="clock" class="credit"></div>
      <div id="credit" class="credit">ä¿¡ç”¨åˆ†ï¼š-</div>
      <button id="logout" class="btn btn-ghost" style="display:none">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <div class="row" id="toolbar">
        <input id="start" class="input" type="datetime-local" />
        <input id="end" class="input" type="datetime-local" />
        <button id="refresh" class="btn btn-ghost">åˆ·æ–°è®¾å¤‡</button>
        <button id="addDevice" class="btn" style="background:#2ecc71;color:#041b12;display:none">æ–°å¢è®¾å¤‡</button>
      </div>
      <div id="devices" class="grid" style="margin-top:12px"></div>
    </div>
  </div>

  <div id="loginModal" class="modal-backdrop">
    <div class="modal login-hero">
      <div class="login-title">ç™»å½•</div>
      <div class="login-sub">æ¬¢è¿è¿›å…¥å®éªŒå®¤è®¾å¤‡ç®¡ç†ç³»ç»Ÿ</div>
      <div class="input-icon">
        <span class="ico">ğŸ‘¤</span>
        <input id="username" class="input" placeholder="ç”¨æˆ·åï¼ˆstudent1 / teacher1 / admin1ï¼‰" />
      </div>
      <div class="input-icon" style="margin-top:8px">
        <span class="ico">ğŸ”’</span>
        <input id="password" class="input" type="password" placeholder="å¯†ç ï¼ˆ123456ï¼‰" />
      </div>
      <div class="login-actions">
        <button id="login" class="btn btn-primary">è¿›å…¥ç³»ç»Ÿ</button>
      </div>
      <div class="muted">æ¼”ç¤ºè´¦å·ï¼šstudent1 / teacher1 / admin1ï¼Œå¯†ç å‡ä¸º 123456</div>
    </div>
  </div>

  <div id="reserveModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <div id="reserveTitle" style="font-weight:700; margin-bottom:8px">é¢„çº¦è®¾å¤‡</div>
      <label>å¼€å§‹æ—¶é—´ï¼š</label>
      <input id="reserve-start" class="input" type="datetime-local" />
      <label style="margin-top:8px; display:block">ç»“æŸæ—¶é—´ï¼š</label>
      <input id="reserve-end" class="input" type="datetime-local" />
      <div id="reserve-reason-wrap" style="display:none; margin-top:8px">
        <label>ç”³è¯·åŸå› ï¼š</label>
        <textarea id="reserve-reason" class="input" style="height:80px"></textarea>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="reserveCancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button id="reserveConfirm" class="btn btn-primary">ç¡®è®¤é¢„çº¦</button>
      </div>
    </div>
  </div>
  <div id="extendModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <div id="extendTitle" style="font-weight:700; margin-bottom:8px">å»¶é•¿é¢„çº¦</div>
      <label>æ–°çš„ç»“æŸæ—¶é—´ï¼š</label>
      <input id="extend-end" class="input" type="datetime-local" />
      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button id="extendCancel" class="btn btn-ghost">å–æ¶ˆ</button>
        <button id="extendConfirm" class="btn btn-primary">ç¡®è®¤å»¶é•¿</button>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('error', function(e){
      alert('å‰ç«¯è„šæœ¬é”™è¯¯ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'));
    });
    // å…¨å±€ç™»å½•çŠ¶æ€
    let currentUser = null;
    let reserveTarget = { id: null, name: '' };
    function isLoggedIn(){ return !!(currentUser && typeof currentUser.userId === 'number'); }
    function getCurrentUserId(){ return isLoggedIn() ? currentUser.userId : null; }
    function isAdmin(){ return !!(currentUser && currentUser.type === 2); }
    function isStudent(){ return !!(currentUser && currentUser.type === 0); }

    function toTimestamp(dtLocal) {
      // å°† input çš„ datetime-local è½¬ä¸ºç§’çº§æ—¶é—´æˆ³
      if (!dtLocal) return null;
      const ms = new Date(dtLocal).getTime();
      if (Number.isNaN(ms)) return null;
      return Math.floor(ms / 1000);
    }

    function fmtHM(ts){
      const d = new Date(ts * 1000);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    function toLocalISOString(date){
      const pad = n => String(n).padStart(2,'0');
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    function setDefaultToolbarTimes(){
      const now = new Date();
      const plus1h = new Date(now.getTime() + 3600*1000);
      const s = document.getElementById('start');
      const e = document.getElementById('end');
      if (s) s.value = toLocalISOString(now);
      if (e) e.value = toLocalISOString(plus1h);
    }

    function openReserve(id, name){
      reserveTarget = { id, name };
      document.getElementById('reserveTitle').textContent = `é¢„çº¦è®¾å¤‡ï¼š${name}`;
      const now = new Date();
      const plus1h = new Date(now.getTime() + 3600*1000);
      document.getElementById('reserve-start').value = toLocalISOString(now);
      document.getElementById('reserve-end').value = toLocalISOString(plus1h);
      const dev = dataLastDeviceMap[id];
      const isApply = isStudent() && dev && dev.allowStudent === false;
      document.getElementById('reserve-reason-wrap').style.display = isApply ? 'block' : 'none';
      document.getElementById('reserveModal').style.display = 'flex';
    }

    function openExtend(devId, currentEnd){
      document.getElementById('extendTitle').textContent = `å»¶é•¿è®¾å¤‡ #${devId} çš„é¢„çº¦`;
      const d = new Date(currentEnd * 1000);
      document.getElementById('extend-end').value = toLocalISOString(d);
      document.getElementById('extendModal').style.display = 'flex';
      reserveTarget = { id: devId, name: '' };
    }

    async function confirmExtend(){
      const endVal = document.getElementById('extend-end').value;
      const newEnd = Math.floor(new Date(endVal).getTime()/1000);
      if (!newEnd || Number.isNaN(newEnd)) { alert('ç»“æŸæ—¶é—´æ— æ•ˆ'); return; }
      const r = await api('/api/extend','POST',{ userId: currentUser.userId, deviceId: reserveTarget.id, endTime: newEnd });
      if (r.credit != null) { currentUser.credit = r.credit; document.getElementById('credit').textContent = `ä¿¡ç”¨åˆ†ï¼š${currentUser.credit}`; }
      alert(r.ok ? 'å»¶é•¿æˆåŠŸ' : 'å»¶é•¿å¤±è´¥ï¼ˆä¸åç»­é¢„çº¦å†²çªï¼‰');
      document.getElementById('extendModal').style.display = 'none';
      await refreshAll();
    }

    async function confirmReserve(){
      const startVal = document.getElementById('reserve-start').value;
      const endVal = document.getElementById('reserve-end').value;
      let start = Math.floor(new Date(startVal).getTime()/1000);
      let end = Math.floor(new Date(endVal).getTime()/1000);
      if (!start || Number.isNaN(start) || !end || Number.isNaN(end)) {
        const nowSec = Math.floor(Date.now()/1000);
        start = nowSec;
        end = nowSec + 3600;
      }
      if (start >= end) { alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´'); return; }
      const dev = reserveTarget;
      if (isStudent()) {
        // å­¦ç”Ÿé«˜é£é™©é™åˆ¶åœ¨æäº¤å‰ç”±æœåŠ¡ç«¯ä¸ç°æœ‰æ ¡éªŒå…±åŒä¿éšœ
      }
      const r = await api('/api/reserve','POST',{ userId: currentUser.userId, deviceId: dev.id, startTime: start, endTime: end });
      alert(r.ok ? 'é¢„çº¦æˆåŠŸ' : 'é¢„çº¦å¤±è´¥ï¼ˆæ—¶é—´å†²çªæˆ–ä¿¡ç”¨ä¸è¶³ï¼‰');
      document.getElementById('reserveModal').style.display = 'none';
      await refreshAll();
    }

    const BASE = window.location.origin || '';
    async function api(path, method = 'GET', data = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) opts.body = JSON.stringify(data);
      try {
        const r = await fetch(BASE + path, opts);
        const text = await r.text();
        try { return JSON.parse(text); } catch { return { ok: false, message: 'å“åº”éJSON', raw: text }; }
      } catch (e) {
        return { ok: false, message: e && e.message ? e.message : 'ç½‘ç»œé”™è¯¯' };
      }
    }

    function typeName(t) {
      return ['è€—æ', 'ç²¾å¯†', 'åŠ¨åŠ›'][t] || 'æœªçŸ¥';
    }
    function statusName(s) {
      return ['ç©ºé—²', 'å·²é¢„çº¦', 'ä½¿ç”¨ä¸­', 'æŸå'][s] || 'æœªçŸ¥';
    }

    let dataLastDeviceMap = {};
    async function loadDevices() {
      const data = await api('/api/devices');
      const wrap = document.getElementById('devices');
      wrap.innerHTML = '';
      if (!data.ok) return;
      dataLastDeviceMap = {};
      data.devices.forEach(dev => {
        dataLastDeviceMap[dev.id] = dev;
        const card = document.createElement('div');
        card.className = 'card';
        const tags = [];
        tags.push(`<span class="tag">ç±»å‹ï¼š${typeName(dev.type)}</span>`);
        tags.push(`<span class="tag">å¥åº·ï¼š${dev.health}</span>`);
        tags.push(`<span class="tag">çŠ¶æ€ï¼š${statusName(dev.status)}</span>`);
        tags.push(`<span class="tag">å­¦ç”Ÿå¯é¢„çº¦ï¼š${dev.allowStudent ? 'æ˜¯' : 'å¦'}</span>`);
        if (dev.materialLevel != null) tags.push(`<span class="tag">ææ–™ï¼š${dev.materialLevel.toFixed(1)}%</span>`);
        if (dev.calibration != null) tags.push(`<span class="tag">æ ¡å‡†ï¼š${dev.calibration.toFixed(1)}%</span>`);
        if (dev.temperature != null) tags.push(`<span class="tag">æ¸©åº¦ï¼š${dev.temperature.toFixed(1)}â„ƒ</span>`);
        const title = document.createElement('div');
        title.className = 'name';
        title.textContent = `${dev.name} (#${dev.id})`;
        card.appendChild(title);
        const tagsEl = document.createElement('div');
        tagsEl.innerHTML = tags.join(' ');
        card.appendChild(tagsEl);

        // æ˜¾ç¤ºå½“å‰æ´»åŠ¨é¢„çº¦æ—¶é—´æ®µ
        const now = Math.floor(Date.now()/1000);
        // å¯è§æ€§ï¼šå­¦ç”Ÿåªçœ‹è‡ªå·±çš„é¢„çº¦æ—¶é—´ï¼›ç®¡ç†å‘˜çœ‹æ‰€æœ‰æ´»è·ƒé¢„çº¦
        const activeList = dev.reservations.filter(r => now >= r.startTime && now <= r.endTime);
        if (activeList.length && dev.status !== 0) {
          const info = document.createElement('div');
          info.style.marginTop = '6px';
          if (isAdmin()) {
            info.innerHTML = activeList.map(r => `<span class="tag">#${r.userId}ï¼š${fmtHM(r.startTime)} - ${fmtHM(r.endTime)}</span>`).join(' ');
          } else {
            const mine = activeList.find(r => r.userId === getCurrentUserId());
            if (mine) info.innerHTML = `<span class="tag">æ—¶é—´ï¼š${fmtHM(mine.startTime)} - ${fmtHM(mine.endTime)}</span>`;
          }
          if (info.innerHTML) card.appendChild(info);
        }

        // æ˜¾ç¤ºè¯¥ç”¨æˆ·åœ¨æ­¤è®¾å¤‡ä¸Šçš„æ‰€æœ‰é¢„çº¦æ—¶é—´ï¼ˆå«å†å²ä¸æœªæ¥ï¼‰
        const myAll = dev.reservations.filter(r => r.userId === getCurrentUserId());
        if (myAll.length) {
          const allDiv = document.createElement('div');
          allDiv.style.marginTop = '6px';
          allDiv.innerHTML = `<span class="tag">æˆ‘çš„é¢„çº¦ï¼š</span>` + myAll.map(r => `<span class="tag">${fmtHM(r.startTime)} - ${fmtHM(r.endTime)}</span>`).join(' ');
          card.appendChild(allDiv);
        }

        const btns = document.createElement('div');
        btns.className = 'row';

        // åŠ¨æ€å±•ç¤ºæŒ‰é’®
        const hasMyActive = dev.reservations.some(r => r.userId === getCurrentUserId() && now >= r.startTime && now <= r.endTime);
        const myRes = dev.reservations.find(r => r.userId === getCurrentUserId());

        // é¢„çº¦æŒ‰é’®
        if (isStudent() && !dev.allowStudent) {
          const btnApply = document.createElement('button');
          btnApply.className = 'btn btn-primary';
          btnApply.textContent = 'ç”³è¯·';
          btnApply.onclick = () => openReserve(dev.id, dev.name);
          btns.appendChild(btnApply);
        } else {
          const btnReserve = document.createElement('button');
          btnReserve.className = 'btn btn-primary';
          btnReserve.textContent = 'é¢„çº¦';
          btnReserve.onclick = () => openReserve(dev.id, dev.name);
          btns.appendChild(btnReserve);
        }

        // å€Ÿç”¨æŒ‰é’®ï¼ˆåœ¨è‡ªå·±çš„é¢„çº¦çª—å£å†…ï¼Œä¸”æœªå€Ÿå‡ºï¼‰
        if (hasMyActive && dev.status === 1) {
          const btnBorrow = document.createElement('button');
          btnBorrow.className = 'btn btn-secondary';
          btnBorrow.textContent = 'å€Ÿç”¨';
          btnBorrow.onclick = async () => {
            const r = await api('/api/borrow', 'POST', { userId: currentUser.userId, deviceId: dev.id });
            alert(r.ok ? 'å€Ÿç”¨æˆåŠŸ' : 'å€Ÿç”¨å¤±è´¥');
            await refreshAll();
          };
          btns.appendChild(btnBorrow);
        }

        // å½’è¿˜æŒ‰é’®ï¼ˆåœ¨è‡ªå·±çš„é¢„çº¦çª—å£å†…ï¼Œä¸”å·²å€Ÿå‡ºï¼‰
        if (hasMyActive && dev.status === 2) {
          const btnReturn = document.createElement('button');
          btnReturn.className = 'btn btn-danger';
          btnReturn.textContent = 'å½’è¿˜';
          btnReturn.onclick = async () => {
            const r = await api('/api/return', 'POST', { userId: currentUser.userId, deviceId: dev.id });
            if (r.credit != null) { currentUser.credit = r.credit; document.getElementById('credit').textContent = `ä¿¡ç”¨åˆ†ï¼š${currentUser.credit}`; }
            alert(r.ok ? 'å½’è¿˜æˆåŠŸï¼ˆå¯èƒ½å› é€¾æœŸæ‰£åˆ†ï¼‰' : 'å½’è¿˜å¤±è´¥');
            await refreshAll();
          };
          btns.appendChild(btnReturn);
        }

        // å»¶é•¿æŒ‰é’®ï¼ˆå¦‚æœå­˜åœ¨æˆ‘çš„é¢„çº¦ï¼‰
        if (myRes) {
          const btnExtend = document.createElement('button');
          btnExtend.className = 'btn btn-ghost';
          btnExtend.textContent = 'å»¶é•¿é¢„çº¦';
          btnExtend.onclick = () => openExtend(dev.id, myRes.endTime);
          btns.appendChild(btnExtend);
        }

        // ç®¡ç†å‘˜ç»´æŠ¤è®¾å¤‡æŒ‰é’®
        if (isAdmin()) {
          const btnMaintain = document.createElement('button');
          btnMaintain.className = 'btn btn-ghost';
          btnMaintain.textContent = 'ç»´æŠ¤è®¾å¤‡';
          btnMaintain.onclick = async () => {
            const r = await api('/api/admin/maintain', 'POST', { deviceId: dev.id });
            alert(r.ok ? 'ç»´æŠ¤å®Œæˆ' : (r.message || 'ç»´æŠ¤å¤±è´¥'));
            await refreshAll();
          };
          btns.appendChild(btnMaintain);
        }

        // ç®¡ç†å‘˜åˆ é™¤è®¾å¤‡æŒ‰é’®
        if (isAdmin()) {
          const btnDelete = document.createElement('button');
          btnDelete.className = 'btn btn-danger';
          btnDelete.textContent = 'åˆ é™¤';
          btnDelete.onclick = async () => {
            const r = await api('/api/admin/delete','POST',{ deviceId: dev.id });
            alert(r.ok ? 'å·²åˆ é™¤' : (r.message || 'åˆ é™¤å¤±è´¥'));
            await refreshAll();
          };
          btns.appendChild(btnDelete);
        }

        card.appendChild(btns);
        wrap.appendChild(card);
      });
    }

    async function refreshAll() {
      await loadDevices();
      if (currentUser) document.getElementById('credit').textContent = `ä¿¡ç”¨åˆ†ï¼š${currentUser.credit}`;
      // æ‹‰å–å­¦ç”Ÿé€šçŸ¥
      if (isStudent() && currentUser) {
        const data = await api(`/api/notifications?userId=${currentUser.userId}`);
        if (data && data.ok && Array.isArray(data.notifications)) {
          data.notifications.forEach(n => alert(n.message));
        }
      }
    }

    document.getElementById('refresh').onclick = refreshAll;
    document.getElementById('logout').onclick = async () => {
      currentUser = null;
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('credit').textContent = 'ä¿¡ç”¨åˆ†ï¼š-';
      document.getElementById('addDevice').style.display = 'none';
    };
    document.getElementById('addDevice').onclick = async () => {
      const name = prompt('è®¾å¤‡åç§°ï¼š');
      if (!name) return;
      const typeStr = prompt('è®¾å¤‡ç±»å‹(0=è€—æ,1=ç²¾å¯†,2=åŠ¨åŠ›)ï¼š');
      const type = Number(typeStr);
      if (![0,1,2].includes(type)) { alert('ç±»å‹è¾“å…¥æ— æ•ˆ'); return; }
      const allowStr = prompt('å­¦ç”Ÿå¯é¢„çº¦ï¼Ÿ(æ˜¯/å¦)ï¼š');
      const allowStudent = (allowStr||'æ˜¯').trim() === 'æ˜¯';
      const r = await api('/api/admin/add','POST',{ name, type, allowStudent });
      alert(r.ok ? `å·²æ–°å¢è®¾å¤‡ #${r.deviceId}` : 'æ–°å¢å¤±è´¥');
      await refreshAll();
    };

    // ç®¡ç†å‘˜æŸ¥çœ‹ç”³è¯·å…¥å£æŒ‰é’®
    if (document.getElementById('toolbar')) {
      const btnApps = document.createElement('button');
      btnApps.className = 'btn';
      btnApps.textContent = 'æŸ¥çœ‹å­¦ç”Ÿç”³è¯·';
      btnApps.style.display = 'none';
      btnApps.id = 'btnApps';
      document.getElementById('toolbar').appendChild(btnApps);
      btnApps.onclick = async () => {
        // è‹¥å¼¹çª—ä¸å­˜åœ¨åˆ™åˆ›å»º
        let modal = document.getElementById('applicationsModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'applicationsModal';
          modal.className = 'modal-backdrop';
          modal.style.display = 'none';
          modal.innerHTML = `<div class=\"modal\"><div style=\"font-weight:700; margin-bottom:8px\">å­¦ç”Ÿé¢„çº¦ç”³è¯·</div><div id=\"applicationsList\" style=\"max-height:240px; overflow:auto; margin-bottom:8px\"></div><div class=\"row\" style=\"justify-content:flex-end\"><button id=\"appsClose\" class=\"btn btn-ghost\">å…³é—­</button></div></div>`;
          document.body.appendChild(modal);
        }
        const data = await api('/api/admin/applications');
        const host = document.getElementById('applicationsList');
        if (!host) { alert('ç”³è¯·åˆ—è¡¨è½½å…¥å¤±è´¥'); return; }
        host.innerHTML = '';
        if (data.ok) {
          data.applications.forEach(a => {
            const row = document.createElement('div');
            row.style.marginBottom = '8px';
            row.innerHTML = `#${a.id} ç”¨æˆ·${a.userId} è®¾å¤‡${a.deviceId} æ—¶é—´ ${fmtHM(a.startTime)} - ${fmtHM(a.endTime)}<br/>åŸå› ï¼š${a.reason || ''}`;
            const approve = document.createElement('button');
            approve.className = 'btn btn-primary';
            approve.textContent = 'æ‰¹å‡†';
            approve.onclick = async () => {
              const r = await api('/api/admin/applications/approve','POST',{ appId: a.id });
              alert(r.ok ? 'å·²æ‰¹å‡†' : 'æ‰¹å‡†å¤±è´¥');
              await refreshAll();
              document.getElementById('applicationsModal').style.display = 'none';
            };
            row.appendChild(approve);
            host.appendChild(row);
          });
        }
        document.getElementById('applicationsModal').style.display = 'flex';
        const closeBtn = document.getElementById('appsClose');
        if (closeBtn) closeBtn.onclick = () => { const m = document.getElementById('applicationsModal'); if (m) m.style.display = 'none'; };
      };
      (function(){
        const closeBtn = document.getElementById('appsClose');
        if (closeBtn) closeBtn.onclick = () => { const m = document.getElementById('applicationsModal'); if (m) m.style.display = 'none'; };
      })();
    }

    const loginBtn = document.getElementById('login');
    if (!loginBtn) { alert('æ‰¾ä¸åˆ°ç™»å½•æŒ‰é’®'); }
    loginBtn.addEventListener('click', async () => {
      try {
        alert('æ­£åœ¨ç™»å½•â€¦');
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        const r = await api('/api/login', 'POST', { username, password });
        if (!r || !r.ok) { alert('ç™»å½•å¤±è´¥' + (r && r.message ? ('ï¼š' + r.message) : '')); return; }
        currentUser = { userId: r.userId, username: r.username, credit: r.credit, priority: r.priority, type: r.type };
        document.getElementById('loginModal').style.display = 'none';
        document.getElementById('logout').style.display = 'inline-block';
        if (currentUser.type === 2) {
          document.getElementById('addDevice').style.display = 'inline-block';
          const aBtn = document.getElementById('btnApps'); if (aBtn) aBtn.style.display = 'inline-block';
        }
        setDefaultToolbarTimes();
        await refreshAll();
      } catch (e) {
        alert('ç™»å½•è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ');
      }
    });

    // é¢„çº¦å¼¹çª—äº‹ä»¶ç»‘å®š
    document.getElementById('reserveCancel').onclick = () => {
      document.getElementById('reserveModal').style.display = 'none';
    };
    document.getElementById('reserveConfirm').onclick = async () => {
      const startVal = document.getElementById('reserve-start').value;
      const endVal = document.getElementById('reserve-end').value;
      let start = Math.floor(new Date(startVal).getTime()/1000);
      let end = Math.floor(new Date(endVal).getTime()/1000);
      if (!start || Number.isNaN(start) || !end || Number.isNaN(end)) { const nowSec=Math.floor(Date.now()/1000); start=nowSec; end=nowSec+3600; }
      if (start >= end) { alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´'); return; }
      const dev = reserveTarget;
      let r;
      if (isStudent() && dataLastDeviceMap[dev.id] && dataLastDeviceMap[dev.id].allowStudent === false) {
        const reason = (document.getElementById('reserve-reason').value || '').trim();
        r = await api('/api/apply','POST',{ userId: currentUser.userId, deviceId: dev.id, startTime: start, endTime: end, reason });
        alert(r.ok ? 'ç”³è¯·å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸' : 'ç”³è¯·å¤±è´¥');
      } else {
        r = await api('/api/reserve','POST',{ userId: currentUser.userId, deviceId: dev.id, startTime: start, endTime: end });
        alert(r.ok ? 'é¢„çº¦æˆåŠŸ' : (r.message || 'é¢„çº¦å¤±è´¥ï¼ˆæ—¶é—´å†²çªæˆ–ä¿¡ç”¨ä¸è¶³ï¼‰'));
      }
      document.getElementById('reserveModal').style.display = 'none';
      await refreshAll();
    };

    // åˆæ¬¡åŠ è½½æ˜¾ç¤ºç™»å½•çª—
    document.getElementById('loginModal').style.display = 'flex';
    setDefaultToolbarTimes();
    setInterval(()=>{
      const d=new Date();
      document.getElementById('clock').textContent = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
    },1000);
    // åˆ é™¤æ—¶é’Ÿæ˜¾ç¤º
    document.getElementById('extendCancel').onclick = () => { document.getElementById('extendModal').style.display = 'none'; };
    document.getElementById('extendConfirm').onclick = confirmExtend;
  </script>
</body>
</html>
 
